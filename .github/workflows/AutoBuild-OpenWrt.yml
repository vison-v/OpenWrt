name: AutoBuild-OpenWrt
on:
  workflow_dispatch:
  schedule:
    - cron: "5 23 1/2 * *"
  watch:
    types: started
permissions:
  contents: read
env:
  REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
  SCKEY: ${{ secrets.SCKEY }}
  PAT: ${{ secrets.PAT }}
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  TZ: Asia/Shanghai
jobs:
  build_openwrt:
    if: github.event.repository.owner.id == github.event.sender.id || ! github.event.sender.id
    runs-on: ubuntu-latest
    name: æ„å»º ${{ matrix.target }}
    strategy:
      fail-fast: false
      matrix:
        target: [lede-x86-64,immortalwrt-x86-64,openwrt-x86-64]
    steps:
    # ========== åˆå§‹åŒ–é˜¶æ®µ ==========
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: è§£æç¯å¢ƒå˜é‡
      run: |
        echo "REPO_NAME=$(basename "${{ matrix.target }}" | awk -F'-' '{print $1}')" >> $GITHUB_ENV  
        echo "ARCH_NAME=$(basename "${{ matrix.target }}" | sed -E 's/^[^-]*-//')" >> $GITHUB_ENV  
        source "${GITHUB_WORKSPACE}/${{ env.REPO_NAME }}/common/settings.ini"  
        # å¦‚æœå­˜åœ¨æ¶æ„ç‰¹å®šçš„é…ç½®ï¼Œåˆ™åŠ è½½  
        if [ -f "${GITHUB_WORKSPACE}/${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/settings.ini" ]; then  
          source "${GITHUB_WORKSPACE}/${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/settings.ini"  
        fi  
        echo "REPO_URL=${REPO_URL}" >> $GITHUB_ENV  
        echo "REPO_BRANCH=${REPO_BRANCH}" >> $GITHUB_ENV  
        echo "CONFIG_FILE=${CONFIG_FILE}" >> $GITHUB_ENV  
        echo "CUSTOM_SH=${CUSTOM_SH}" >> $GITHUB_ENV  
        echo "COMMON_SH=${COMMON_SH}" >> $GITHUB_ENV
        echo "DATE_TAG=$(date +'%Y.%m.%d')" >> $GITHUB_ENV
        
    # ========== ç¼“å­˜æ¢å¤é˜¶æ®µ ==========
    - name: æ¢å¤ç¼–è¯‘ç¼“å­˜
      id: cache-restore
      uses: actions/cache@v4
      with:
        path: |
          ${{ github.workspace }}/dl_cache
          ${{ github.workspace }}/ccache
        key: ${{ runner.os }}-${{ matrix.target }}-${{ hashFiles(format('{0}/common/config.diff', env.REPO_NAME), format('{0}/{1}/config.diff', env.REPO_NAME, env.ARCH_NAME)) }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.target }}-
          ${{ runner.os }}-
    
    # ========== ç¯å¢ƒå‡†å¤‡é˜¶æ®µ ==========    
    - name: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo timedatectl set-timezone "Asia/Shanghai"
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          libssl-dev \
          python3-dev \
          moreutils  # æ·»åŠ æ—¶é—´æˆ³å·¥å…·
        sudo mkdir -p /usr/local/ccache
        echo "max_size = 10G" | sudo tee /usr/local/ccache/ccache.conf
        echo "PATH=$PATH:/usr/lib/ccache" >> $GITHUB_ENV

    # ========== æºç å¤„ç†é˜¶æ®µ ==========    
    - name: å…‹éš†æºä»£ç 
      run: |
        git clone --depth 1 "$REPO_URL" -b "$REPO_BRANCH" "${GITHUB_WORKSPACE}/${REPO_NAME}"
        
    - name: é…ç½®ç¬¦å·é“¾æ¥
      run: |
        mkdir -p "${GITHUB_WORKSPACE}/tmp_cache"
        ln -sfT "${GITHUB_WORKSPACE}/dl_cache" "${REPO_NAME}/dl"
        ln -sfT "${GITHUB_WORKSPACE}/ccache" "${REPO_NAME}/ccache"
        ln -sfT "${GITHUB_WORKSPACE}/tmp_cache" "${REPO_NAME}/build_dir"

    # ========== é…ç½®å¤„ç†é˜¶æ®µ ==========    
    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
      run: |
        # å¤åˆ¶é€šç”¨é…ç½®æ–‡ä»¶
        cp -rv "${REPO_NAME}/common/files/." "${GITHUB_WORKSPACE}/${REPO_NAME}/" || true
        # å¤åˆ¶æ¶æ„ç‰¹å®šæ–‡ä»¶
        [ -d "${REPO_NAME}/${ARCH_NAME}/files" ] && \
          cp -rv "${REPO_NAME}/${ARCH_NAME}/files/." "${GITHUB_WORKSPACE}/${REPO_NAME}/"
          
        # é…ç½®feeds
        cd "${REPO_NAME}"
        echo "src-git vi https://github.com/vison-v/packages;${REPO_NAME}" >> feeds.conf.default
        ./scripts/feeds update -a
        [ -x "${REPO_NAME}/common/feeds-vi.sh" ] && \
          "${REPO_NAME}/common/feeds-vi.sh"
        ./scripts/feeds install -a --force-overwrite

        # é€šç”¨è„šæœ¬å¤„ç†
        if [[ -n "${COMMON_SH}" && -f "common/${COMMON_SH}" ]]; then
          echo "::group::ğŸ—ï¸ æ‰§è¡Œé€šç”¨è‡ªå®šä¹‰è„šæœ¬ï¼šcommon/${COMMON_SH}"
          chmod +x "common/${COMMON_SH}"
          SANITIZED_PATH=$(echo "common/${COMMON_SH}" | sed 's/\\/\\\\/g; s/"/\\"/g')
          echo "æ‰§è¡Œè·¯å¾„: ${SANITIZED_PATH}"
          bash "common/${COMMON_SH}"
          echo "::endgroup::"
        fi
        
        # æ¶æ„è„šæœ¬å¤„ç†
        if [[ -n "${CUSTOM_SH}" && -f "${ARCH_NAME}/${CUSTOM_SH}" ]]; then
          echo "::group::ğŸ­ æ‰§è¡Œæ¶æ„è‡ªå®šä¹‰è„šæœ¬ï¼š${ARCH_NAME}/${CUSTOM_SH}"
          chmod +x "${ARCH_NAME}/${CUSTOM_SH}"
          SANITIZED_PATH=$(echo "${ARCH_NAME}/${CUSTOM_SH}" | sed 's/\\/\\\\/g; s/"/\\"/g')
          echo "æ‰§è¡Œè·¯å¾„: ${SANITIZED_PATH}"
          bash "${ARCH_NAME}/${CUSTOM_SH}"
          echo "::endgroup::"
        fi
        
    - name: ç”Ÿæˆé…ç½®æ–‡ä»¶
      run: |
        cd "${REPO_NAME}"
        # åˆå¹¶é…ç½®æ–‡ä»¶
        cat "${REPO_NAME}/common/config.diff" > .config
        [ -f "${REPO_NAME}/${ARCH_NAME}/config.diff" ] && \
          cat "${REPO_NAME}/${ARCH_NAME}/config.diff" >> .config
        make defconfig

    # ========== ç¼–è¯‘é˜¶æ®µ ==========    
    - name: ä¸‹è½½ä¾èµ–é¡¹
      if: ${{ steps.cache-restore.outputs.cache-hit != 'true' }}
      run: |
        cd "${REPO_NAME}"
        make download -j$(nproc) CHECK_CERTIFICATE=1
        
    - name: æ‰§è¡Œç¼–è¯‘
      id: compile
      run: |
        cd "${REPO_NAME}"
        echo "::group::å¤šçº¿ç¨‹ç¼–è¯‘æ—¥å¿—ï¼ˆV=sçº§åˆ«ï¼‰"
        if ! make -j$(($(nproc)+1)) V=s 2>&1 | ts '[%Y-%m-%d %H:%M:%S]'; then
          echo "::endgroup::"
          echo "::warning::å¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œå¯ç”¨å•çº¿ç¨‹è°ƒè¯•æ¨¡å¼..."
          echo "::group::å•çº¿ç¨‹è¯¦ç»†æ—¥å¿—ï¼ˆV=scçº§åˆ«ï¼‰"
          make -j1 V=sc 2>&1 | ts '[FAILURE] ' > "${GITHUB_WORKSPACE}/firmware/${REPO_NAME}_${ARCH_NAME}_error.log"
          echo "::endgroup::"
          echo "BUILD_STATUS=failed" >> $GITHUB_ENV
          exit 1
        else
          echo "::endgroup::"
          echo "BUILD_STATUS=success" >> $GITHUB_ENV
        fi
        
        echo "::notice::å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ"
        df -h | grep -E 'Filesystem|% Used'

    # ========== äº§ç‰©å¤„ç†é˜¶æ®µ ==========    
    - name: æ•´ç†ç¼–è¯‘äº§ç‰©
      if: ${{ env.BUILD_STATUS == 'success' }}
      run: |
        mkdir -p firmware
        find "${REPO_NAME}/bin/targets" \
          -type \( -name "*.img.gz" -o -name "*.bin" -o -name "*.iso" \) \
          -exec cp -v {} firmware/ \;
        cd firmware
        sha256sum * > sha256sums.txt
        echo "å›ºä»¶ç‰ˆæœ¬: ${{ env.DATE_TAG }}" > release.md

    # ========== å‘å¸ƒé˜¶æ®µ ==========    
    - name: å‘å¸ƒåˆ°GitHub Releases
      uses: softprops/action-gh-release@v2
      if: ${{ env.BUILD_STATUS == 'success' && env.UPLOAD_FIRMWARE_FOR_RELEASE == 'true' }}
      with:
        files: |
          firmware/*
        tag_name: "${{ env.DATE_TAG }}-${{ matrix.target }}-${GITHUB_RUN_ID}"
        name: "${{ env.DATE_TAG }} ${{ matrix.target }} Build"
        body_path: firmware/release.md

    # ========== é€šçŸ¥é˜¶æ®µ ==========    
    - name: æ¨é€Telegramé€šçŸ¥
      if: ${{ env.TELEGRAM_TOKEN }}
      env:
        BUILD_RESULT: ${{ env.BUILD_STATUS }}
      run: |
        if [ "$BUILD_RESULT" = "success" ]; then
          MSG="âœ… *${{ matrix.target }} ç¼–è¯‘æˆåŠŸ*  
          â± å®Œæˆæ—¶é—´: $(date +'%Y-%m-%d %T')  
          ğŸ”— ä¸‹è½½åœ°å€: https://github.com/$GITHUB_REPOSITORY/releases/tag/${{ env.DATE_TAG }}-${{ matrix.target }}-${GITHUB_RUN_ID}"
        else
          ERROR_LOG=$(tail -n 50 "${{ github.workspace }}/firmware/${REPO_NAME}_${ARCH_NAME}_error.log" | sed 's/"/\\"/g')
          MSG="âŒ *${{ matrix.target }} ç¼–è¯‘å¤±è´¥*  
          ğŸ•’ å¤±è´¥æ—¶é—´: $(date +'%Y-%m-%d %T')  
          ğŸ“„ é”™è¯¯æ—¥å¿—æ‘˜è¦:  
          \`\`\`
          $ERROR_LOG
          \`\`\`"
        fi
        
        curl -sS -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_TOKEN }}/sendMessage" \
          -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
          -d text="$MSG" \
          -d parse_mode="MarkdownV2" \
          -d disable_web_page_preview=true

    # ========== æ¸…ç†é˜¶æ®µ ==========    
    - name: æ¸…ç†æ—§ç‰ˆæœ¬å‘å¸ƒ
      uses: dev-drprasad/delete-older-releases@master
      if: ${{ github.event_name == 'schedule' }}
      with:
        keep_latest: 15
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

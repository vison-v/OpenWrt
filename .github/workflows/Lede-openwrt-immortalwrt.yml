# Copyright (C) 2022 Ing <https://github.com/wjz304>. 
# This is free software, licensed under the MIT License.  
# See /LICENSE for more information.  
name: Build OpenWrt  
on:  
  #schedule:  
  #  - cron: "0 18 * * *"  
  push:  
    paths:  
      - '.github/workflows/Lede-openwrt-immortalwrt.yml'  
  workflow_dispatch:  

env:  
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}  
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}  

jobs:  
  matrix:  
    runs-on: ubuntu-latest  
    outputs:  
      release: ${{ steps.set-matrix.outputs.release }}  
      matrix: ${{ steps.set-matrix.outputs.matrix }}  
    steps:  
      - name: Checkout  
        uses: actions/checkout@main  
      
      - name: Generate build matrix  
        id: set-matrix  
        run: |  
          sudo timedatectl set-timezone "Asia/Shanghai"  
          echo "release=$(date +"%Y.%m.%d")" >> $GITHUB_OUTPUT  
          cp -rf Lede-openwrt-immortalwrt/* ./  
          echo "matrix={ \"config\": [ $(echo $(ls -mBQ *.config)) ] }" >> $GITHUB_OUTPUT  

  build:  
    name: Build OpenWrt  
    runs-on: ubuntu-latest  
    needs: matrix  
    env:  
      release: ${{ needs.matrix.outputs.release }}  
    strategy:  
      matrix: ${{ fromJson(needs.matrix.outputs.matrix) }}  
    steps:  
      - name: Checkout  
        uses: actions/checkout@main  
      
      - name: Init Env  
        env:  
          DEBIAN_FRONTEND: noninteractive  
        run: |  
          git config --global user.email "github-actions[bot]@users.noreply.github.com"  
          git config --global user.name "github-actions[bot]"  
          sudo timedatectl set-timezone "Asia/Shanghai"  
          sudo apt update  
          sudo apt full-upgrade -y  
          sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
          git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev \
          libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
          libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf npm python3 \
          python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo \
          uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev  
          sudo apt -y autoremove --purge  
          sudo apt -y clean  

          # Clone and build po2lmo  
          git clone --depth=1 https://github.com/openwrt-dev/po2lmo || { echo 'Clone failed'; exit 1; }  
          (cd po2lmo && sudo make && sudo make install)  
          df -h  
      
      - name: make  
        continue-on-error: true   
        run: |  
          sudo mkdir -p /mnt/openwrt  
          sudo cp -rf Lede-openwrt-immortalwrt/* /mnt/openwrt/  
          cd /mnt/openwrt  
          
          # è®¾ç½®æ–‡ä»¶åå˜é‡
          REPO_NAME=$(basename "${{ matrix.config }}" | awk -F';' '{printf $1}')
          ARCH_NAME=$(basename "${{ matrix.config }}" | awk -F';' '{printf $3}')
          FILE_NAME=${REPO_NAME}-${ARCH_NAME}
          LOG_NAME=${FILE_NAME}_make_error.log
          echo "FILE_NAME=${FILE_NAME}" >> $GITHUB_ENV 
          echo "LOG_NAME=${FILE_NAME}_make_error.log" >> $GITHUB_ENV 

          # æ‰§è¡Œ build.sh è„šæœ¬å¹¶å¤„ç†é”™è¯¯  
          if ! sudo bash build.sh "${{ matrix.config }}"; then  
            echo "Build.sh å¯¹é…ç½®"${{ env.FILE_NAME }}æ‰§è¡Œå¤±è´¥ï¼"  
          else  
            echo "Build.sh å¯¹é…ç½®"${{ env.FILE_NAME }}æ‰§è¡ŒæˆåŠŸï¼"    
          fi  

          # æ‰§è¡Œmakeå‘½ä»¤ï¼Œè‹¥å¤±è´¥è¿”å›é”™è¯¯ç 1å¹¶è®°å½•é”™è¯¯æ—¥å¿—è·¯å¾„  
          pushd ${REPO_NAME}
          make -j$(nproc) V=s || make -j1 V=s  

          if [ $? -ne 0 ]; then  
          echo "BUILD_STATUS=failed" >> $GITHUB_ENV   # å¤±è´¥æ—¶è®¾ç½®çŠ¶æ€å˜é‡  
          echo "${FILE_NAME}å›ºä»¶æ„å»ºå¤±è´¥!"  
          echo "${FILE_NAME}æ„å»ºé”™è¯¯æ—¥å¿—:"  
          cat "${LOG_NAME}"  
          mv -f "${LOG_NAME}" "${WORKSPACE}"  
          exit 1    
          else  
          echo "BUILD_STATUS=success" >> $GITHUB_ENV  # æˆåŠŸæ—¶è®¾ç½®çŠ¶æ€å˜é‡  
          echo "${FILE_NAME}å›ºä»¶æ„å»ºæˆåŠŸ!"  
          fi  
          popd || exit 1  # ç¡®ä¿è¿”å›æˆåŠŸ
          ls -al  
          du -chd1
          echo "${FILE_NAME}ç¼–è¯‘å®Œæˆ"

          # ç§»åŠ¨æ„å»ºäº§ç‰©  
          pushd bin/targets/*/* || exit 1  # ç¡®ä¿ç›®å½•å˜æ›´æˆåŠŸ  
          ls -al  
          # ç§»åŠ¨æ–‡ä»¶åˆ°å·¥ä½œç©ºé—´  
          if ls *combined*.img.gz 1> /dev/null 2>&1; then  
          mv -f *combined*.img.gz "${WORKSPACE}"  
          else  
          echo "æ²¡æœ‰å‘ç°ç¼–è¯‘å¥½çš„å›ºä»¶ï¼"  
          exit 1  
          fi  
          popd || exit 1  # ç¡®ä¿è¿”å›æˆåŠŸ  
          
      - name: ä¸Šä¼ æ—¥å¿—åˆ°artifact  
        if: env.BUILD_STATUS == 'failed'  # ä»…åœ¨æ„å»ºå¤±è´¥æ—¶ä¸Šä¼ æ—¥å¿—  
        uses: actions/upload-artifact@main  
        continue-on-error: true  
        with:  
          name: ${{ env.FILE_NAME }}_make_error  
          path: |  
            /mnt/openwrt/${{ env.ERROR_LOG_NAME }}  
      
      - name: ä¸Šä¼ å›ºä»¶åˆ°artifact  
        if: env.BUILD_STATUS == 'success'    
        uses: actions/upload-artifact@main  
        with:  
          name: ${{ env.FILE_NAME }}-${{ env.release }}  
          path: |  
            /mnt/openwrt/*.img.gz  
      
      - name: ä¸Šä¼ å›ºä»¶åˆ°release  
        if: env.BUILD_STATUS == 'success'  
        uses: softprops/action-gh-release@v2  
        env:  
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}  
        with:  
          tag_name: ${{ env.release }}  
          files: /mnt/openwrt/*basic*.img.gz
      
      - name: Telegram notification  
        if: env.TELEGRAM_TOKEN  
        continue-on-error: true  
        run: |  
          if [ ${{ env.BUILD_STATUS }} == 'success' ]; then  
          message="å›ºä»¶${{ env.FILE_NAME }}-${{ env.release }}ç¼–è¯‘å®ŒæˆğŸ˜‹"  
          else  
          message="å›ºä»¶${{ env.FILE_NAME }}-${{ env.release }}ç¼–è¯‘å¤±è´¥ğŸ˜­"  
          fi  
          curl -k --data chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" --data "text=${message}" "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage"

    # Uncomment to keep workflow clean  
    # - name: Delete workflow runs  
    #   uses: Mattraks/delete-workflow-runs@v2  
    #   with:  
    #     retain_days: 1  
    #     keep_minimum_runs: 9  
    # - name: Remove old Releases  
    #   uses: dev-drprasad/delete-older-releases@v0.1.0  
    #   with:  
    #     keep_latest: 9  
    #     delete_tags: true  
    #   env:  
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#=================================================  
# https://github.com/P3TERX/Actions-OpenWrt  
# æè¿°: ä½¿ç”¨ GitHub Actions æ„å»º OpenWrt  
# è®¸å¯è¯: MIT  
# ä½œè€…: P3TERX  
# åšå®¢: https://p3terx.com  
#=================================================  

name: Openwrt-AutoBuild  

on:   
  # å½“æ¨é€å·¥ä½œæµæ–‡ä»¶æ—¶è§¦å‘  
  push:  
    paths:  
      - '.github/workflows/Openwrt-AutoBuild-Lean.yml'  

permissions:  
  contents: read  

env:  
  REPO_TOKEN: ${{ secrets.REPO_TOKEN }}  
  SCKEY: ${{ secrets.SCKEY }}  
  PAT: ${{ secrets.PAT }}  
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}  
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}  
  TZ: Asia/Shanghai  

jobs:  
  build_openwrt:  
    name: æ„å»º ${{ matrix.target }}  
    runs-on: ubuntu-latest  
    strategy:  
      fail-fast: false  
      matrix:  
        target: [lede_x86_64_basic,lede_AC58U]  
        
    steps:  
    - name: æ£€å‡ºä»£ç   
      uses: actions/checkout@main  
      with:  
          fetch-depth: 0  
  
    - name: é…ç½®ç¯å¢ƒå˜é‡  
      run: |  
        echo "FILE_NAME=${{ matrix.target }}" >> $GITHUB_ENV   
        echo "REPO_NAME=$(basename "${{ matrix.target }}" | awk -F'_' '{print $1}')" >> $GITHUB_ENV  
        echo "ARCH_NAME=$(basename "${{ matrix.target }}" | sed -E 's/^[^_]*_//')" >> $GITHUB_ENV  
        echo "date=$(date +'%Y.%m.%d')" >> $GITHUB_ENV  
  
    - name: åŠ è½½Settings.ini  
      run: |  
        # åŠ è½½å…¬å…±é…ç½®  
        source "${GITHUB_WORKSPACE}/${{ env.REPO_NAME }}/common/settings.ini"  
        # å¦‚æœå­˜åœ¨æ¶æ„ç‰¹å®šçš„é…ç½®ï¼Œåˆ™åŠ è½½  
        if [ -f "${GITHUB_WORKSPACE}/${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/settings.ini" ]; then  
          source "${GITHUB_WORKSPACE}/${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/settings.ini"  
        fi  
        # ä»é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ç¯å¢ƒå˜é‡  
        echo "REPO_URL=${REPO_URL}" >> $GITHUB_ENV  
        echo "REPO_BRANCH=${REPO_BRANCH}" >> $GITHUB_ENV  
        echo "CONFIG_FILE=${CONFIG_FILE}" >> $GITHUB_ENV  
        echo "CUSTOM_SH=${CUSTOM_SH}" >> $GITHUB_ENV  
        echo "COMMON_SH=${COMMON_SH}" >> $GITHUB_ENV  
        echo "UPLOAD_BIN_FIRMWARE_FOR_ARTIFACT=${UPLOAD_BIN_FIRMWARE_FOR_ARTIFACT}" >> $GITHUB_ENV  
        echo "UPLOAD_FIRMWARE_FOR_ARTIFACT=${UPLOAD_FIRMWARE_FOR_ARTIFACT}" >> $GITHUB_ENV  
        echo "UPLOAD_EFI_FIRMWARE_FOR_ARTIFACT=${UPLOAD_EFI_FIRMWARE_FOR_ARTIFACT}" >> $GITHUB_ENV  
        echo "UPLOAD_ISO_FIRMWARE_FOR_ARTIFACT=${UPLOAD_ISO_FIRMWARE_FOR_ARTIFACT}" >> $GITHUB_ENV  
        echo "UPLOAD_FIRMWARE_FOR_RELEASE=${UPLOAD_FIRMWARE_FOR_RELEASE}" >> $GITHUB_ENV  
    
    - name: åŠ è½½ç¯å¢ƒ  
      env:  
          DEBIAN_FRONTEND: noninteractive  
      run: |  
          # å®‰è£…å¿…è¦çš„è½¯ä»¶åŒ…  
          sudo -E apt-get -qq update  
          sudo -E apt-get -qq install build-essential clang llvm flex g++ gawk gcc-multilib gettext \
          git libncurses5-dev libssl-dev python3-distutils python3-pyelftools python3-setuptools \
          libpython3-dev rsync unzip zlib1g-dev swig aria2 jq subversion qemu-utils ccache rename \
          libelf-dev device-tree-compiler libgnutls28-dev coccinelle libgmp3-dev libmpc-dev  
          # ç§»é™¤ä¸å¿…è¦çš„åŒ…ï¼Œæ¸…ç†ç©ºé—´  
          sudo -E apt-get -qq purge azure-cli ghc* zulu* firefox powershell openjdk* dotnet* google* mysql* php* android*  
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc  
          sudo -E apt-get -qq autoremove --purge  
          sudo -E apt-get -qq clean  
          sudo -E timedatectl set-timezone "Asia/Shanghai"  
          df -h  
    
    - name: å…‹éš†æºä»£ç   
      run: |  
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt  
    
    - name: åŠ è½½ä¸æ›´æ–°feeds  
      run: |  
        cp -rf ${{ env.REPO_NAME }}/common/files/. openwrt/  
        cd openwrt  
        #sed -i "/src-git vi /d; 1 i src-git vi https://github.com/vison-v/packages;${{ env.REPO_NAME }}" feeds.conf.default  		  
        ./scripts/feeds update -a  
        ./scripts/feeds install -a  
        #./scripts/feeds uninstall $(grep Package ./feeds/vi.index | awk -F': ' '{print $2}')  
        #./scripts/feeds install -p vi -a  

    - name: æ¸…ç†ç£ç›˜ç©ºé—´  
      env:  
        DEBIAN_FRONTEND: noninteractive  
      run: |  
        # åˆ›å»ºç›®å½•ä»¥é‡Šæ”¾ç£ç›˜ç©ºé—´  
        sudo mkdir -p -m 777 /mnt/openwrt/dl /mnt/openwrt/bin /mnt/openwrt/staging_dir /mnt/openwrt/build_dir  
        ln -sf /mnt/openwrt/dl openwrt/dl  
        ln -sf /mnt/openwrt/bin openwrt/bin  
        ln -sf /mnt/openwrt/staging_dir openwrt/staging_dir  
        ln -sf /mnt/openwrt/build_dir openwrt/build_dir  
    
    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®  
      run: |  
        cp -rf ${{ env.REPO_NAME }} openwrt/  
        cd openwrt  
        chmod +x ${{ env.REPO_NAME }}/common/$COMMON_SH  
        /bin/bash "${{ env.REPO_NAME }}/common/$COMMON_SH"   # æ‰§è¡Œé€šç”¨è„šæœ¬  
        # æ‰§è¡Œæ¶æ„ç‰¹å®šçš„è„šæœ¬  
        if [ -f "${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/$CUSTOM_SH" ]; then  
          chmod +x ${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/$CUSTOM_SH  
          /bin/bash "${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/$CUSTOM_SH"  
        fi  
        mv ${{ env.REPO_NAME }}/common/$CONFIG_FILE .config  # ç§»åŠ¨é…ç½®æ–‡ä»¶  
        # å¦‚æœå­˜åœ¨æ¶æ„ç‰¹å®šçš„é…ç½®æ–‡ä»¶ï¼Œåˆ™è¿½åŠ å†…å®¹  
        if [ -f "${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/$CONFIG_FILE" ]; then  
          echo >> .config  
          cat ${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/$CONFIG_FILE >> .config  
        fi  
    
    - name: åº”ç”¨è¡¥ä¸  
      run: |  
        cd openwrt  
        # åº”ç”¨é€šç”¨è¡¥ä¸  
        if [ "$(find "${{ env.REPO_NAME }}/common/patches" -type f ! -path '${{ env.REPO_NAME }}/common/patches/china_mirrors.patch' -name '*.patch' -print -quit)" ]; then  
          find "${{ env.REPO_NAME }}/common/patches" -type f ! -path '${{ env.REPO_NAME }}/common/patches/china_mirrors.patch' -name '*.patch' -print0 | \
          sort -z | xargs -I % -t -0 -n 1 sh -c "cat '%'  | patch -d './' -p1 -E --forward --no-backup-if-mismatch"  
        fi  
        # å¦‚æœå­˜åœ¨æ¶æ„ç‰¹å®šçš„è¡¥ä¸ï¼Œäº¦å°†å…¶åº”ç”¨  
        if [ -n "$(ls -A "${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/patches" 2>/dev/null)" ]; then  
          find "${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/patches" -type f -name '*.patch' -print0 | sort -z | xargs -I % -t -0 -n 1 sh -c "cat '%'  | patch -d './' -p1 -E --forward --no-backup-if-mismatch"  
        fi  

    - name: ä¸‹è½½è½¯ä»¶åŒ…  
      id: package  
      run: |  
        cd openwrt  
        make defconfig  
        make download -j16  
        df -h  
    
    - name: ç¼–è¯‘å›ºä»¶  
      id: compile  
      run: | 
        set -e
        cd openwrt  
        echo -e "ç”¨ $(($(nproc)+1)) çº¿ç¨‹ç¼–è¯‘${{ matrix.target }}......"  
        make -j$(($(nproc)+1)) || make -j1 V=s > make_output.log 2> ${{matrix.target}}_make_error.log  
        echo "=============================================="  
        echo "ç©ºé—´ä½¿ç”¨æƒ…å†µ:"  
        echo "=============================================="  
        df -h  
        echo "=============================================="  
        if [ $? -ne 0 ]; then  
          echo "BUILD_STATUS=failed" >> $GITHUB_ENV   # å¤±è´¥æ—¶è®¾ç½®çŠ¶æ€å˜é‡  
          echo "${{matrix.target}} å›ºä»¶æ„å»ºå¤±è´¥!"  
          echo "${{matrix.target}} æ„å»ºé”™è¯¯æ—¥å¿—:"  
          cat ${{matrix.target}}_make_error.log  
          exit 1    
        else  
          echo "BUILD_STATUS=success" >> $GITHUB_ENV  # æˆåŠŸæ—¶è®¾ç½®çŠ¶æ€å˜é‡  
          echo "${{matrix.target}} å›ºä»¶æ„å»ºæˆåŠŸ!"   
          echo "=============================================="  
          ls bin/targets/*/*  
          echo "=============================================="  
        fi
        du -h --max-depth=5 ./logs

    # ç»„ç»‡æ–‡ä»¶  
    - name: ç»„ç»‡æ–‡ä»¶  
      continue-on-error: true  
      if: ${{ env.BUILD_STATUS == 'success' }}  
      id: organize  
      run: |  
        # åˆ›å»º firmware ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰  
        mkdir -p firmware  
        # åˆ é™¤å¹¶å¤åˆ¶æ–‡ä»¶åˆ° firmware ç›®å½•   
        rm -rf $(find openwrt/bin/targets/ \( -type d -name "packages" -o -name "*buildinfo" -o -name "*json" -o -name "*manifest" \)) 
        cp -rf $(find openwrt/bin/targets/ -type f -name "*") ./firmware
        cp -rf $(find openwrt/ -type f -name "*_error.log") ./firmware
        # æ£€æŸ¥å›ºä»¶æ–‡ä»¶æ˜¯å¦å­˜åœ¨  
        if [ -n "$(find ./firmware/ -type f -print -quit)" ]; then  
          # å¦‚æœæ–‡ä»¶å­˜åœ¨  
          cp openwrt/.config ./firmware/${{ matrix.target }}.config  
          cd firmware  
          echo -e "${{ env.date }}ç¼–è¯‘\n\n\n" > version.txt                            # å†™å…¥ç‰ˆæœ¬ä¿¡æ¯  
          echo "â¤ï¸==============================================â¤ï¸" >> release.txt  
          echo -e "Releaseå›ºä»¶ä¸ºæµ‹è¯•å›ºä»¶ï¼Œæœ›é¡»çŸ¥ï¼ï¼\n\n" >> release.txt  
          grep -E '\.img\.gz$|\.bin$|\.iso$' sha256sums >> version.txt                 # è¿½åŠ  sha256sums åˆ°ç‰ˆæœ¬æ–‡ä»¶  
          echo "â¤ï¸==============================================â¤ï¸" >> release.txt  
          mv sha256sums ${{ matrix.target }}_sha256sums                                # é‡å‘½å sha256sums æ–‡ä»¶  
          echo "FIRMWARE_STATUS=found" >> $GITHUB_ENV                                  # è®¾ç½®çŠ¶æ€ä¸º found  
          # æ£€æŸ¥å„ç±»å›ºä»¶æ–‡ä»¶å­˜åœ¨æ€§å¹¶è®¾ç½®ç¯å¢ƒå˜é‡  
          [ -n "$(find . -name '*_error.log' -print -quit)" ] && echo "LOG=true" >> $GITHUB_ENV || echo "LOG=false" >> $GITHUB_ENV 
          [ -n "$(find . -name '*image.iso' -print -quit)" ] && echo "ISO=true" >> $GITHUB_ENV || echo "ISO=false" >> $GITHUB_ENV  
          [ -n "$(find . -name '*sysupgrade.bin' -print -quit)" ] && echo "BIN=true" >> $GITHUB_ENV || echo "BIN=false" >> $GITHUB_ENV  
          [ -n "$(find . -name '*combined-efi.img.gz' -print -quit)" ] && echo "EFI=true" >> $GITHUB_ENV || echo "EFI=false" >> $GITHUB_ENV  
          [ -n "$(find . -name '*combined.img.gz' -print -quit)" ] && echo "COMBINED=true" >> $GITHUB_ENV || echo "COMBINED=false" >> $GITHUB_ENV  
          ls                                                                           # åˆ—å‡ºæ–‡ä»¶ä»¥ä¾›è°ƒè¯•  
        else  
          echo "æœªæ‰¾åˆ°æ–‡ä»¶."  
        fi

    # ä¸Šä¼ å›ºä»¶åˆ° Release  
    - name: ä¸Šä¼ å›ºä»¶åˆ° Release  
      uses: softprops/action-gh-release@v2  
      continue-on-error: true
      if: ${{ env.REPO_TOKEN && env.UPLOAD_FIRMWARE_FOR_RELEASE == 'true' && env.FIRMWARE_STATUS == 'found' }}
      env:  
        GITHUB_TOKEN: env.REPO_TOKEN                                     # ä½¿ç”¨å¯†é’¥è¿›è¡Œèº«ä»½éªŒè¯  
      with:  
        files: firmware/*                                                # è¦ä¸Šä¼ çš„æ–‡ä»¶  
        name: ${{matrix.target}}                                         # Release çš„åç§°  
        tag_name: ${{ env.date }}_${{matrix.target}}                     # æ ‡è®°åç§°  
        body_path: firmware/release.txt                                  # Release æè¿°æ–‡ä»¶è·¯å¾„  

    # ä¸Šä¼ å›ºä»¶åˆ° Artifact  
    - name: ä¸Šä¼ å›ºä»¶åˆ° Artifact   
      uses: actions/upload-artifact@v4  
      continue-on-error: true
      if: ${{ env.UPLOAD_FIRMWARE_FOR_ARTIFACT == 'true' && env.COMBINED == 'true' }}
      with:  
        name: ${{ env.date }}_${{matrix.target}}   
        path: firmware/*combined.img.gz

    # ä¸Šä¼  EFI å›ºåˆ° Artifact  
    - name: ä¸Šä¼  EFI å›ºåˆ° Artifact  
      uses: actions/upload-artifact@v4  
      continue-on-error: true
      if: ${{ env.UPLOAD_EFI_FIRMWARE_FOR_ARTIFACT == 'true' && env.EFI == 'true' }}  
      with:  
        name: ${{ env.date }}_${{matrix.target}}_EFI   
        path: firmware/*combined-efi.img.gz    

    # ä¸Šä¼  BIN å›ºåˆ° Artifact  
    - name: ä¸Šä¼  BIN å›ºåˆ° Artifact  
      uses: actions/upload-artifact@v4  
      continue-on-error: true
      if: ${{ env.UPLOAD_BIN_FIRMWARE_FOR_ARTIFACT == 'true' && env.BIN == 'true' }}  
      with:  
        name: ${{ env.date }}_${{matrix.target}}_BIN   
        path: firmware/*sysupgrade.bin  

    # ä¸Šä¼  ISO å›ºä»¶åˆ° Artifact  
    - name: ä¸Šä¼  ISO å›ºä»¶åˆ° Artifact  
      uses: actions/upload-artifact@v4  
      continue-on-error: true
      if: ${{ env.UPLOAD_ISO_FIRMWARE_FOR_ARTIFACT == 'true' && env.ISO == 'true' }}  
      with:  
        name: ${{ env.date }}_${{matrix.target}}_ISO  
        path: firmware/*image.iso   

    # ä¸Šä¼ makeé”™è¯¯æ—¥å¿—åˆ° Artifact  
    - name: ä¸Šä¼ é”™è¯¯æ—¥å¿—åˆ° Artifact  
      uses: actions/upload-artifact@v4  
      continue-on-error: true
      if: ${{ env.LOG == 'true' }}  
      with:  
        name: ${{matrix.target}}_make_error           # è®¾ç½®ä¸Šä¼ æ–‡ä»¶çš„åç§°  
        path: firmware/*make_error.log                # ä¸Šä¼ çš„é”™è¯¯æ—¥å¿—æ–‡ä»¶è·¯å¾„  

    # å¾®ä¿¡é€šçŸ¥  
    - name: å¾®ä¿¡é€šçŸ¥  
      if: env.SCKEY                                   # å¦‚æœå·²è®¾ç½® SCKEY åˆ™å‘é€é€šçŸ¥  
      run: |  
        if [ "${{ env.COMBINED }}" == 'true' ] || [ "${{ env.EFI }}" == 'true' ] || [ "${{ env.BIN }}" == 'true' ] || [ "${{ env.ISO }}" == 'true' ]; then  
          curl https://sc.ftqq.com/${{ secrets.SCKEY }}.send?text=å›ºä»¶${{ env.date }}_${{matrix.target}}ç¼–è¯‘å®ŒæˆğŸ˜‹  
        else  
          curl https://sc.ftqq.com/${{ secrets.SCKEY }}.send?text=å›ºä»¶${{ env.date }}_${{matrix.target}}ç¼–è¯‘å¤±è´¥ğŸ˜­  
        fi  

    # Telegram é€šçŸ¥  
    - name: Telegram é€šçŸ¥  
      if: env.TELEGRAM_TOKEN                          # å¦‚æœå·²è®¾ç½® Telegram ä»¤ç‰Œåˆ™å‘é€é€šçŸ¥  
      run: |  
       if [ "${{ env.COMBINED }}" == 'true' ] || [ "${{ env.EFI }}" == 'true' ] || [ "${{ env.BIN }}" == 'true' ] || [ "${{ env.ISO }}" == 'true' ]; then  
         message="å›ºä»¶${{ env.date }}_${{ matrix.target }}ç¼–è¯‘å®ŒæˆğŸ˜‹"  
       else  
         message="å›ºä»¶${{ env.date }}_${{ matrix.target }}ç¼–è¯‘å¤±è´¥ğŸ˜­"  
       fi  
       curl -k --data "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" --data "text=${message}" "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage"

    # åˆ é™¤å·¥ä½œæµè¿è¡Œè®°å½•  
    - name: åˆ é™¤å·¥ä½œæµè¿è¡Œè®°å½•  
      uses: Mattraks/delete-workflow-runs@main  
      with:  
        token: env.PAT                                # ä½¿ç”¨ PAT è¿›è¡Œèº«ä»½éªŒè¯  
        retain_days: 15                               # ä¿ç•™æœ€è¿‘ 15 å¤©çš„è®°å½•  
        keep_minimum_runs: 5                          # ä¿ç•™è‡³å°‘ 5 æ¬¡è¿è¡Œè®°å½•  

    # åˆ é™¤æ—§çš„ Releases  
    - name: åˆ é™¤æ—§çš„ Releases  
      uses: dev-drprasad/delete-older-releases@master  
      continue-on-error: true
      if: ${{ env.UPLOAD_FIRMWARE_FOR_RELEASE == 'true' }}   # ä»…åœ¨å…è®¸ä¸Šä¼ æ—¶æ‰§è¡Œ  
      with:  
        keep_latest: 15                                      # ä¿ç•™æœ€æ–°çš„ 15 ä¸ªå‘å¸ƒ  
        delete_tags: true                                    # åˆ é™¤æ ‡ç­¾  
      env:  
        GITHUB_TOKEN: env.REPO_TOKEN                         # ä½¿ç”¨ GitHub ä»¤ç‰Œ

name: Openwrt-AutoBuild  

on:   
  push:  
    paths:  
      - '.github/workflows/Openwrt-AutoBuild.yml'  

permissions:  
  contents: read  

env:  
  REPO_TOKEN: ${{ secrets.REPO_TOKEN }}  
  SCKEY: ${{ secrets.SCKEY }}  
  PAT: ${{ secrets.PAT }}  
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}  
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}  
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}  
  TZ: Asia/Shanghai  

jobs:  
  build_openwrt:  
    name: æ„å»º ${{ matrix.target }}  
    runs-on: ubuntu-latest  
    strategy:  
      fail-fast: false  
      matrix:  
        target: [lede_x86_64_basic]  
        
    steps:  
    
      - name: æ£€å‡ºä»£ç   
        uses: actions/checkout@main  
        with:  
          fetch-depth: 0  
  
      - name: é…ç½®ç¯å¢ƒå˜é‡  
        run: |  
          echo "FILE_NAME=${{ matrix.target }}" >> $GITHUB_ENV   
          echo "REPO_NAME=$(basename "${{ matrix.target }}" | awk -F'_' '{print $1}')" >> $GITHUB_ENV  
          echo "ARCH_NAME=$(basename "${{ matrix.target }}" | sed -E 's/^[^_]*_//')" >> $GITHUB_ENV  
          echo "date=$(date +'%Y.%m.%d')" >> $GITHUB_ENV  
  
      - name: åŠ è½½Settings.ini  
        run: |  
          # åŠ è½½å…¬å…±é…ç½®  
          source "${GITHUB_WORKSPACE}/${{ env.REPO_NAME }}/common/settings.ini"  
          
          # åŠ è½½æ¶æ„ç‰¹å®šçš„é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰  
          if [ -f "${GITHUB_WORKSPACE}/${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/settings.ini" ]; then  
            source "${GITHUB_WORKSPACE}/${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/settings.ini"  
          fi  
          
          # å®‰è£…æ‰€æœ‰çš„ feeds  
          ./scripts/feeds install -p vi -a

- name: æ¸…ç†ç£ç›˜ç©ºé—´  
  env:  
    DEBIAN_FRONTEND: noninteractive  
  run: |  
    # åˆ›å»ºç›®å½•ä»¥é‡Šæ”¾ç£ç›˜ç©ºé—´  
    sudo mkdir -p -m 777 /mnt/openwrt/dl /mnt/openwrt/bin /mnt/openwrt/staging_dir /mnt/openwrt/build_dir  
    ln -sf /mnt/openwrt/dl openwrt/dl  
    ln -sf /mnt/openwrt/bin openwrt/bin  
    ln -sf /mnt/openwrt/staging_dir openwrt/staging_dir  
    ln -sf /mnt/openwrt/build_dir openwrt/build_dir  

- name: åŠ è½½è‡ªå®šä¹‰é…ç½®  
  run: |  
    cp -rf ${{ env.REPO_NAME }} openwrt/  
    cd openwrt  
    chmod +x "${{ env.REPO_NAME }}/common/$COMMON_SH"  
    /bin/bash "${{ env.REPO_NAME }}/common/$COMMON_SH"     # æ‰§è¡Œé€šç”¨è„šæœ¬  

    # æ‰§è¡Œæ¶æ„ç‰¹å®šçš„è„šæœ¬  
    if [ -f "${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/$CUSTOM_SH" ]; then  
      chmod +x "${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/$CUSTOM_SH"  
      /bin/bash "${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/$CUSTOM_SH"  
    fi  

    mv "${{ env.REPO_NAME }}/common/$CONFIG_FILE" .config  # ç§»åŠ¨é…ç½®æ–‡ä»¶  

    # å¦‚æœå­˜åœ¨æ¶æ„ç‰¹å®šçš„é…ç½®æ–‡ä»¶ï¼Œåˆ™è¿½åŠ å†…å®¹  
    if [ -f "${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/$CONFIG_FILE" ]; then  
      echo >> .config  
      cat "${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/$CONFIG_FILE" >> .config  
    fi  

- name: åº”ç”¨è¡¥ä¸  
  run: |  
    cd openwrt  
    # åº”ç”¨é€šç”¨è¡¥ä¸  
    find "${{ env.REPO_NAME }}/common/patches" -type f ! -path "${{ env.REPO_NAME }}/common/patches/china_mirrors.patch" -name '*.patch' -print0 | sort -z | xargs -0 -I % -t sh -c "cat '%' | patch -d './' -p1 -E --forward --no-backup-if-mismatch"  

    # å¦‚æœå­˜åœ¨æ¶æ„ç‰¹å®šçš„è¡¥ä¸ï¼Œäº¦å°†å…¶åº”ç”¨  
    if [ -n "$(ls -A "${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/patches" 2>/dev/null)" ]; then  
      find "${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/patches" -type f -name '*.patch' -print0 | sort -z | xargs -0 -I % -t sh -c "cat '%' | patch -d './' -p1 -E --forward --no-backup-if-mismatch"  
    fi  

- name: ä¸‹è½½è½¯ä»¶åŒ…  
  id: package  
  run: |  
    cd openwrt  
    make defconfig  
    make download -j16  
    df -h  

- name: ç¼–è¯‘å›ºä»¶  
  id: compile  
  run: |   
    set -e  
    cd openwrt  
    echo -e "$(($(nproc)+1)) çº¿ç¨‹ç¼–è¯‘"  
    make -j$(($(nproc)+1)) || make -j1 V=s > make_output.log 2> "${{ matrix.target }}_make_error.log"  
    echo "=============================================="  
    echo "ç©ºé—´ä½¿ç”¨æƒ…å†µ:"  
    echo "=============================================="  
    df -h  
    echo "=============================================="

# ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶ç›®å½•  
- name: ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶  
  continue-on-error: true                                  # é‡åˆ°é”™è¯¯æ—¶ç»§ç»­æ‰§è¡Œ  
  if: env.UPLOAD_EFI_FIRMWARE_FOR_ARTIFACT == 'true' && env.BUILD_STATUS == 'success'  
  with:  
    name: ${{ env.date }} ${{ matrix.target }}_EFI         # è®¾ç½®ä¸Šä¼ æ–‡ä»¶çš„åç§°  
    path: ${{ env.FIRMWARE }}/*efi*                        # ä¸Šä¼ çš„ EFI æ–‡ä»¶è·¯å¾„  

# ä¸Šä¼  ISO å›ºä»¶åˆ° Artifact  
- name: ä¸Šä¼  ISO å›ºä»¶åˆ° Artifact  
  uses: actions/upload-artifact@main  
  continue-on-error: true                                  # é‡åˆ°é”™è¯¯æ—¶ç»§ç»­æ‰§è¡Œ  
  if: env.UPLOAD_ISO_FIRMWARE_FOR_ARTIFACT == 'true' && env.BUILD_STATUS == 'success'  
  with:  
    name: ${{ env.date }} ${{ matrix.target }}_ISO         # è®¾ç½®ä¸Šä¼ æ–‡ä»¶çš„åç§°  
    path: ${{ env.FIRMWARE }}/*.iso                        # ä¸Šä¼ çš„ ISO æ–‡ä»¶è·¯å¾„  

# ä¸Šä¼ é”™è¯¯æ—¥å¿—åˆ° Artifact  
- name: ä¸Šä¼ é”™è¯¯æ—¥å¿—åˆ° Artifact  
  uses: actions/upload-artifact@main  
  continue-on-error: true                                  # é‡åˆ°é”™è¯¯æ—¶ç»§ç»­æ‰§è¡Œ  
  if: env.BUILD_STATUS == 'failed'  
  with:  
    name: ${{ matrix.target }}_make_error                  # è®¾ç½®ä¸Šä¼ æ–‡ä»¶çš„åç§°  
    path: ./*.log                                          # ä¸Šä¼ çš„é”™è¯¯æ—¥å¿—æ–‡ä»¶è·¯å¾„  

# å¾®ä¿¡é€šçŸ¥  
- name: å¾®ä¿¡é€šçŸ¥  
  continue-on-error: true                                  # é‡åˆ°é”™è¯¯æ—¶ç»§ç»­æ‰§è¡Œ  
  if: env.SCKEY                                            # å¦‚æœå·²è®¾ç½® SCKEY åˆ™å‘é€é€šçŸ¥  
  run: |  
    if [ "${{ env.BUILD_STATUS }}" = "success" ]; then  
      curl -s "https://sc.ftqq.com/${{ secrets.SCKEY }}.send?text=å›ºä»¶${{ env.date }}_${{ matrix.target }}ç¼–è¯‘å®ŒæˆğŸ˜‹"  
    else  
      curl -s "https://sc.ftqq.com/${{ secrets.SCKEY }}.send?text=å›ºä»¶${{ env.date }}_${{ matrix.target }}ç¼–è¯‘å¤±è´¥ğŸ˜­"  
    fi  

# Telegram é€šçŸ¥  
- name: Telegram é€šçŸ¥  
  if: env.TELEGRAM_TOKEN                                   # å¦‚æœå·²è®¾ç½® Telegram ä»¤ç‰Œåˆ™å‘é€é€šçŸ¥  
  continue-on-error: true  
  run: |  
    if [ "${{ env.BUILD_STATUS }}" = "success" ]; then  
      message="å›ºä»¶${{ env.FILE_NAME }}-${{ env.release }}ç¼–è¯‘å®ŒæˆğŸ˜‹"  
    else  
      message="å›ºä»¶${{ env.FILE_NAME }}-${{ env.release }}ç¼–è¯‘å¤±è´¥ğŸ˜­"  
    fi  
    curl -s -k --data "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" --data "text=${message}" "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage"  

# åˆ é™¤å·¥ä½œæµè¿è¡Œè®°å½•  
- name: åˆ é™¤å·¥ä½œæµè¿è¡Œè®°å½•  
  uses: Mattraks/delete-workflow-runs@main  
  with:  
    token: ${{ secrets.PAT }}                              # ä½¿ç”¨ PAT è¿›è¡Œèº«ä»½éªŒè¯  
    retain_days: 15                                        # ä¿ç•™æœ€è¿‘ 15 å¤©çš„è®°å½•  
    keep_minimum_runs: 1                                   # ä¿ç•™è‡³å°‘ 1 æ¬¡è¿è¡Œè®°å½•  

# åˆ é™¤æ—§çš„ Releases  
- name: åˆ é™¤æ—§çš„ Releases  
  uses: dev-drprasad/delete-older-releases@master  
  continue-on-error: true                                  # é‡åˆ°é”™è¯¯æ—¶ç»§ç»­æ‰§è¡Œ  
  if: env.UPLOAD_FIRMWARE_FOR_RELEASE == 'true'            # ä»…åœ¨å…è®¸ä¸Šä¼ æ—¶æ‰§è¡Œ  
  with:  
    keep_latest: 15                                        # ä¿ç•™æœ€æ–°çš„ 15 ä¸ªå‘å¸ƒ  
    delete_tags: true                                      # åˆ é™¤æ ‡ç­¾  
  env:  
    GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}                # ä½¿ç”¨ GitHub ä»¤ç‰Œ